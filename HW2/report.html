<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="style/userpages.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
</head>

<body>
    <div id="control-box">
        <input type="text" name="name" placeholder="New Full name" id="fninp">
        <button onclick="fnchange()">Change Full name</button>
    </div>
    <div id="progsecwrap">
        <section id="progsec">
            <h1>Progress</h1>
        </section>
    </div>
    <script>
        var xhr = new XMLHttpRequest();
        xhr.open("GET", '/completion/', true);
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4) {
                let res = JSON.parse(xhr.responseText)
                console.log(res)
                for (i = 0; i < res.length; i++) {
                    let percentage = Math.ceil((res[i].CQuestionCount / res[i].QuestionCount) * 100) + "%"

                    let node = document.createElement("div")

                    let hwrapper = document.createElement("div")
                    hwrapper.id = "hwrapper"

                    let header = document.createElement("h2")
                    let htext = document.createTextNode(res[i].QuizTitle)
                    header.appendChild(htext)
                    hwrapper.appendChild(header)

                    let percCounter = document.createElement("h2")
                    let percText = document.createTextNode(percentage)
                    percCounter.id = "perccounter"
                    percCounter.appendChild(percText)
                    hwrapper.appendChild(percCounter)
                    node.appendChild(hwrapper)

                    let progressdiv = document.createElement("div")
                    progressdiv.classList.add("progress");
                    node.appendChild(progressdiv)

                    let progressinsidediv = document.createElement("div")
                    progressinsidediv.classList.add("progressinside");
                    progressinsidediv.id = "progress-" + i;
                    progressdiv.appendChild(progressinsidediv)
                    progressinsidediv.style.width = percentage

                    document.getElementById("progsec").appendChild(node)
                }
            }
        }
        xhr.send(null);
        function fnchange() {

            let fn = document.getElementById("fninp").value

            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/fnchange/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = () => {
                if (xhr.readyState == 4) {
                    let res = JSON.parse(xhr.responseText)
                    document.getElementById("errmsg")?.remove();
                    var node = document.createElement("H2");
                    node.id = "errmsg"
                    var textnode

                    if (res.errcode == 4) {
                        textnode = document.createTextNode("Full name is too short")
                    }
                    else if (res.errcode == -2) {
                        textnode = document.createTextNode("Full name changed succesfully!")
                    }
                    node.appendChild(textnode);
                    document.getElementById("control-box").appendChild(node);
                }
            }
            xhr.send(JSON.stringify({
                fn: fn
            }));
        }
    </script>
</body>

</html>